#include <Arduino.h>

class WaveGenerator {
private:
    uint32_t phase;
    uint32_t phase_delta;
    float volume_gain;
    const int32_t sample_rate;
    uint8_t preset = 0x00;

    int16_t square[2048] = {0, -32, -64, -96, -128, -160, -192, -224, -256, -288, -320, -352, -384, -416, -448, -480, -512, -544, -576, -608, -640, -672, -704, -736, -768, -800, -832, -864, -896, -928, -960, -992, -1024, -1056, -1088, -1120, -1152, -1184, -1216, -1248, -1280, -1312, -1344, -1376, -1408, -1440, -1472, -1504, -1536, -1568, -1600, -1632, -1664, -1696, -1728, -1760, -1792, -1824, -1856, -1888, -1920, -1952, -1984, -2016, -2048, -2080, -2112, -2144, -2176, -2208, -2240, -2272, -2304, -2336, -2368, -2400, -2432, -2464, -2496, -2528, -2560, -2592, -2624, -2656, -2688, -2720, -2752, -2784, -2816, -2848, -2880, -2912, -2944, -2976, -3008, -3040, -3072, -3104, -3136, -3168, -3200, -3232, -3264, -3296, -3328, -3360, -3392, -3424, -3456, -3488, -3520, -3552, -3584, -3616, -3648, -3680, -3712, -3744, -3776, -3808, -3840, -3872, -3904, -3936, -3968, -4000, -4032, -4064, -4096, -4128, -4160, -4192, -4224, -4256, -4288, -4320, -4352, -4384, -4416, -4448, -4480, -4512, -4544, -4576, -4608, -4640, -4672, -4704, -4736, -4768, -4800, -4832, -4864, -4896, -4928, -4960, -4992, -5024, -5056, -5088, -5120, -5152, -5184, -5216, -5248, -5280, -5312, -5344, -5376, -5408, -5440, -5472, -5504, -5536, -5568, -5600, -5632, -5664, -5696, -5728, -5760, -5792, -5824, -5856, -5888, -5920, -5952, -5984, -6016, -6048, -6080, -6112, -6144, -6176, -6208, -6240, -6272, -6304, -6336, -6368, -6400, -6432, -6464, -6496, -6528, -6560, -6592, -6624, -6656, -6688, -6720, -6752, -6784, -6816, -6848, -6880, -6912, -6944, -6976, -7008, -7040, -7072, -7104, -7136, -7168, -7200, -7232, -7264, -7296, -7328, -7360, -7392, -7424, -7456, -7488, -7520, -7552, -7584, -7616, -7648, -7680, -7712, -7744, -7776, -7808, -7840, -7872, -7904, -7936, -7968, -8000, -8032, -8064, -8096, -8128, -8160, -8192, -8224, -8256, -8288, -8320, -8352, -8384, -8416, -8448, -8480, -8512, -8544, -8576, -8608, -8640, -8672, -8704, -8736, -8768, -8800, -8832, -8864, -8896, -8928, -8960, -8992, -9024, -9056, -9088, -9120, -9152, -9184, -9216, -9248, -9280, -9312, -9344, -9376, -9408, -9440, -9472, -9504, -9536, -9568, -9600, -9632, -9664, -9696, -9728, -9760, -9792, -9824, -9856, -9888, -9920, -9952, -9984, -10016, -10048, -10080, -10112, -10144, -10176, -10208, -10240, -10272, -10304, -10336, -10368, -10400, -10432, -10464, -10496, -10528, -10560, -10592, -10624, -10656, -10688, -10720, -10752, -10784, -10816, -10848, -10880, -10912, -10944, -10976, -11008, -11040, -11072, -11104, -11136, -11168, -11200, -11232, -11264, -11296, -11328, -11360, -11392, -11424, -11456, -11488, -11520, -11552, -11584, -11616, -11648, -11680, -11712, -11744, -11776, -11808, -11840, -11872, -11904, -11936, -11968, -12000, -12032, -12064, -12096, -12128, -12160, -12192, -12224, -12256, -12288, -12320, -12352, -12384, -12416, -12448, -12480, -12512, -12544, -12576, -12608, -12640, -12672, -12704, -12736, -12768, -12800, -12832, -12864, -12896, -12928, -12960, -12992, -13024, -13056, -13088, -13120, -13152, -13184, -13216, -13248, -13280, -13312, -13344, -13376, -13408, -13440, -13472, -13504, -13536, -13568, -13600, -13632, -13664, -13696, -13728, -13760, -13792, -13824, -13856, -13888, -13920, -13952, -13984, -14016, -14048, -14080, -14112, -14144, -14176, -14208, -14240, -14272, -14304, -14336, -14368, -14400, -14432, -14464, -14496, -14528, -14560, -14592, -14624, -14656, -14688, -14720, -14752, -14784, -14816, -14848, -14880, -14912, -14944, -14976, -15008, -15040, -15072, -15104, -15136, -15168, -15200, -15232, -15264, -15296, -15328, -15360, -15392, -15424, -15456, -15488, -15520, -15552, -15584, -15616, -15648, -15680, -15712, -15744, -15776, -15808, -15840, -15872, -15904, -15936, -15968, -16000, -16032, -16064, -16096, -16128, -16160, -16192, -16224, -16256, -16288, -16320, -16352, -16384, -16352, -16320, -16288, -16256, -16224, -16192, -16160, -16128, -16096, -16064, -16032, -16000, -15968, -15936, -15904, -15872, -15840, -15808, -15776, -15744, -15712, -15680, -15648, -15616, -15584, -15552, -15520, -15488, -15456, -15424, -15392, -15360, -15328, -15296, -15264, -15232, -15200, -15168, -15136, -15104, -15072, -15040, -15008, -14976, -14944, -14912, -14880, -14848, -14816, -14784, -14752, -14720, -14688, -14656, -14624, -14592, -14560, -14528, -14496, -14464, -14432, -14400, -14368, -14336, -14304, -14272, -14240, -14208, -14176, -14144, -14112, -14080, -14048, -14016, -13984, -13952, -13920, -13888, -13856, -13824, -13792, -13760, -13728, -13696, -13664, -13632, -13600, -13568, -13536, -13504, -13472, -13440, -13408, -13376, -13344, -13312, -13280, -13248, -13216, -13184, -13152, -13120, -13088, -13056, -13024, -12992, -12960, -12928, -12896, -12864, -12832, -12800, -12768, -12736, -12704, -12672, -12640, -12608, -12576, -12544, -12512, -12480, -12448, -12416, -12384, -12352, -12320, -12288, -12256, -12224, -12192, -12160, -12128, -12096, -12064, -12032, -12000, -11968, -11936, -11904, -11872, -11840, -11808, -11776, -11744, -11712, -11680, -11648, -11616, -11584, -11552, -11520, -11488, -11456, -11424, -11392, -11360, -11328, -11296, -11264, -11232, -11200, -11168, -11136, -11104, -11072, -11040, -11008, -10976, -10944, -10912, -10880, -10848, -10816, -10784, -10752, -10720, -10688, -10656, -10624, -10592, -10560, -10528, -10496, -10464, -10432, -10400, -10368, -10336, -10304, -10272, -10240, -10208, -10176, -10144, -10112, -10080, -10048, -10016, -9984, -9952, -9920, -9888, -9856, -9824, -9792, -9760, -9728, -9696, -9664, -9632, -9600, -9568, -9536, -9504, -9472, -9440, -9408, -9376, -9344, -9312, -9280, -9248, -9216, -9184, -9152, -9120, -9088, -9056, -9024, -8992, -8960, -8928, -8896, -8864, -8832, -8800, -8768, -8736, -8704, -8672, -8640, -8608, -8576, -8544, -8512, -8480, -8448, -8416, -8384, -8352, -8320, -8288, -8256, -8224, -8192, -8160, -8128, -8096, -8064, -8032, -8000, -7968, -7936, -7904, -7872, -7840, -7808, -7776, -7744, -7712, -7680, -7648, -7616, -7584, -7552, -7520, -7488, -7456, -7424, -7392, -7360, -7328, -7296, -7264, -7232, -7200, -7168, -7136, -7104, -7072, -7040, -7008, -6976, -6944, -6912, -6880, -6848, -6816, -6784, -6752, -6720, -6688, -6656, -6624, -6592, -6560, -6528, -6496, -6464, -6432, -6400, -6368, -6336, -6304, -6272, -6240, -6208, -6176, -6144, -6112, -6080, -6048, -6016, -5984, -5952, -5920, -5888, -5856, -5824, -5792, -5760, -5728, -5696, -5664, -5632, -5600, -5568, -5536, -5504, -5472, -5440, -5408, -5376, -5344, -5312, -5280, -5248, -5216, -5184, -5152, -5120, -5088, -5056, -5024, -4992, -4960, -4928, -4896, -4864, -4832, -4800, -4768, -4736, -4704, -4672, -4640, -4608, -4576, -4544, -4512, -4480, -4448, -4416, -4384, -4352, -4320, -4288, -4256, -4224, -4192, -4160, -4128, -4096, -4064, -4032, -4000, -3968, -3936, -3904, -3872, -3840, -3808, -3776, -3744, -3712, -3680, -3648, -3616, -3584, -3552, -3520, -3488, -3456, -3424, -3392, -3360, -3328, -3296, -3264, -3232, -3200, -3168, -3136, -3104, -3072, -3040, -3008, -2976, -2944, -2912, -2880, -2848, -2816, -2784, -2752, -2720, -2688, -2656, -2624, -2592, -2560, -2528, -2496, -2464, -2432, -2400, -2368, -2336, -2304, -2272, -2240, -2208, -2176, -2144, -2112, -2080, -2048, -2016, -1984, -1952, -1920, -1888, -1856, -1824, -1792, -1760, -1728, -1696, -1664, -1632, -1600, -1568, -1536, -1504, -1472, -1440, -1408, -1376, -1344, -1312, -1280, -1248, -1216, -1184, -1152, -1120, -1088, -1056, -1024, -992, -960, -928, -896, -864, -832, -800, -768, -736, -704, -672, -640, -608, -576, -544, -512, -480, -448, -416, -384, -352, -320, -288, -256, -224, -192, -160, -128, -96, -64, -32, 0, 32, 64, 96, 128, 160, 192, 224, 256, 288, 320, 352, 384, 416, 448, 480, 512, 544, 576, 608, 640, 672, 704, 736, 768, 800, 832, 864, 896, 928, 960, 992, 1024, 1056, 1088, 1120, 1152, 1184, 1216, 1248, 1280, 1312, 1344, 1376, 1408, 1440, 1472, 1504, 1536, 1568, 1600, 1632, 1664, 1696, 1728, 1760, 1792, 1824, 1856, 1888, 1920, 1952, 1984, 2016, 2048, 2080, 2112, 2144, 2176, 2208, 2240, 2272, 2304, 2336, 2368, 2400, 2432, 2464, 2496, 2528, 2560, 2592, 2624, 2656, 2688, 2720, 2752, 2784, 2816, 2848, 2880, 2912, 2944, 2976, 3008, 3040, 3072, 3104, 3136, 3168, 3200, 3232, 3264, 3296, 3328, 3360, 3392, 3424, 3456, 3488, 3520, 3552, 3584, 3616, 3648, 3680, 3712, 3744, 3776, 3808, 3840, 3872, 3904, 3936, 3968, 4000, 4032, 4064, 4096, 4128, 4160, 4192, 4224, 4256, 4288, 4320, 4352, 4384, 4416, 4448, 4480, 4512, 4544, 4576, 4608, 4640, 4672, 4704, 4736, 4768, 4800, 4832, 4864, 4896, 4928, 4960, 4992, 5024, 5056, 5088, 5120, 5152, 5184, 5216, 5248, 5280, 5312, 5344, 5376, 5408, 5440, 5472, 5504, 5536, 5568, 5600, 5632, 5664, 5696, 5728, 5760, 5792, 5824, 5856, 5888, 5920, 5952, 5984, 6016, 6048, 6080, 6112, 6144, 6176, 6208, 6240, 6272, 6304, 6336, 6368, 6400, 6432, 6464, 6496, 6528, 6560, 6592, 6624, 6656, 6688, 6720, 6752, 6784, 6816, 6848, 6880, 6912, 6944, 6976, 7008, 7040, 7072, 7104, 7136, 7168, 7200, 7232, 7264, 7296, 7328, 7360, 7392, 7424, 7456, 7488, 7520, 7552, 7584, 7616, 7648, 7680, 7712, 7744, 7776, 7808, 7840, 7872, 7904, 7936, 7968, 8000, 8032, 8064, 8096, 8128, 8160, 8192, 8224, 8256, 8288, 8320, 8352, 8384, 8416, 8448, 8480, 8512, 8544, 8576, 8608, 8640, 8672, 8704, 8736, 8768, 8800, 8832, 8864, 8896, 8928, 8960, 8992, 9024, 9056, 9088, 9120, 9152, 9184, 9216, 9248, 9280, 9312, 9344, 9376, 9408, 9440, 9472, 9504, 9536, 9568, 9600, 9632, 9664, 9696, 9728, 9760, 9792, 9824, 9856, 9888, 9920, 9952, 9984, 10016, 10048, 10080, 10112, 10144, 10176, 10208, 10240, 10272, 10304, 10336, 10368, 10400, 10432, 10464, 10496, 10528, 10560, 10592, 10624, 10656, 10688, 10720, 10752, 10784, 10816, 10848, 10880, 10912, 10944, 10976, 11008, 11040, 11072, 11104, 11136, 11168, 11200, 11232, 11264, 11296, 11328, 11360, 11392, 11424, 11456, 11488, 11520, 11552, 11584, 11616, 11648, 11680, 11712, 11744, 11776, 11808, 11840, 11872, 11904, 11936, 11968, 12000, 12032, 12064, 12096, 12128, 12160, 12192, 12224, 12256, 12288, 12320, 12352, 12384, 12416, 12448, 12480, 12512, 12544, 12576, 12608, 12640, 12672, 12704, 12736, 12768, 12800, 12832, 12864, 12896, 12928, 12960, 12992, 13024, 13056, 13088, 13120, 13152, 13184, 13216, 13248, 13280, 13312, 13344, 13376, 13408, 13440, 13472, 13504, 13536, 13568, 13600, 13632, 13664, 13696, 13728, 13760, 13792, 13824, 13856, 13888, 13920, 13952, 13984, 14016, 14048, 14080, 14112, 14144, 14176, 14208, 14240, 14272, 14304, 14336, 14368, 14400, 14432, 14464, 14496, 14528, 14560, 14592, 14624, 14656, 14688, 14720, 14752, 14784, 14816, 14848, 14880, 14912, 14944, 14976, 15008, 15040, 15072, 15104, 15136, 15168, 15200, 15232, 15264, 15296, 15328, 15360, 15392, 15424, 15456, 15488, 15520, 15552, 15584, 15616, 15648, 15680, 15712, 15744, 15776, 15808, 15840, 15872, 15904, 15936, 15968, 16000, 16032, 16064, 16096, 16128, 16160, 16192, 16224, 16256, 16288, 16320, 16352, 16384, 16352, 16320, 16288, 16256, 16224, 16192, 16160, 16128, 16096, 16064, 16032, 16000, 15968, 15936, 15904, 15872, 15840, 15808, 15776, 15744, 15712, 15680, 15648, 15616, 15584, 15552, 15520, 15488, 15456, 15424, 15392, 15360, 15328, 15296, 15264, 15232, 15200, 15168, 15136, 15104, 15072, 15040, 15008, 14976, 14944, 14912, 14880, 14848, 14816, 14784, 14752, 14720, 14688, 14656, 14624, 14592, 14560, 14528, 14496, 14464, 14432, 14400, 14368, 14336, 14304, 14272, 14240, 14208, 14176, 14144, 14112, 14080, 14048, 14016, 13984, 13952, 13920, 13888, 13856, 13824, 13792, 13760, 13728, 13696, 13664, 13632, 13600, 13568, 13536, 13504, 13472, 13440, 13408, 13376, 13344, 13312, 13280, 13248, 13216, 13184, 13152, 13120, 13088, 13056, 13024, 12992, 12960, 12928, 12896, 12864, 12832, 12800, 12768, 12736, 12704, 12672, 12640, 12608, 12576, 12544, 12512, 12480, 12448, 12416, 12384, 12352, 12320, 12288, 12256, 12224, 12192, 12160, 12128, 12096, 12064, 12032, 12000, 11968, 11936, 11904, 11872, 11840, 11808, 11776, 11744, 11712, 11680, 11648, 11616, 11584, 11552, 11520, 11488, 11456, 11424, 11392, 11360, 11328, 11296, 11264, 11232, 11200, 11168, 11136, 11104, 11072, 11040, 11008, 10976, 10944, 10912, 10880, 10848, 10816, 10784, 10752, 10720, 10688, 10656, 10624, 10592, 10560, 10528, 10496, 10464, 10432, 10400, 10368, 10336, 10304, 10272, 10240, 10208, 10176, 10144, 10112, 10080, 10048, 10016, 9984, 9952, 9920, 9888, 9856, 9824, 9792, 9760, 9728, 9696, 9664, 9632, 9600, 9568, 9536, 9504, 9472, 9440, 9408, 9376, 9344, 9312, 9280, 9248, 9216, 9184, 9152, 9120, 9088, 9056, 9024, 8992, 8960, 8928, 8896, 8864, 8832, 8800, 8768, 8736, 8704, 8672, 8640, 8608, 8576, 8544, 8512, 8480, 8448, 8416, 8384, 8352, 8320, 8288, 8256, 8224, 8192, 8160, 8128, 8096, 8064, 8032, 8000, 7968, 7936, 7904, 7872, 7840, 7808, 7776, 7744, 7712, 7680, 7648, 7616, 7584, 7552, 7520, 7488, 7456, 7424, 7392, 7360, 7328, 7296, 7264, 7232, 7200, 7168, 7136, 7104, 7072, 7040, 7008, 6976, 6944, 6912, 6880, 6848, 6816, 6784, 6752, 6720, 6688, 6656, 6624, 6592, 6560, 6528, 6496, 6464, 6432, 6400, 6368, 6336, 6304, 6272, 6240, 6208, 6176, 6144, 6112, 6080, 6048, 6016, 5984, 5952, 5920, 5888, 5856, 5824, 5792, 5760, 5728, 5696, 5664, 5632, 5600, 5568, 5536, 5504, 5472, 5440, 5408, 5376, 5344, 5312, 5280, 5248, 5216, 5184, 5152, 5120, 5088, 5056, 5024, 4992, 4960, 4928, 4896, 4864, 4832, 4800, 4768, 4736, 4704, 4672, 4640, 4608, 4576, 4544, 4512, 4480, 4448, 4416, 4384, 4352, 4320, 4288, 4256, 4224, 4192, 4160, 4128, 4096, 4064, 4032, 4000, 3968, 3936, 3904, 3872, 3840, 3808, 3776, 3744, 3712, 3680, 3648, 3616, 3584, 3552, 3520, 3488, 3456, 3424, 3392, 3360, 3328, 3296, 3264, 3232, 3200, 3168, 3136, 3104, 3072, 3040, 3008, 2976, 2944, 2912, 2880, 2848, 2816, 2784, 2752, 2720, 2688, 2656, 2624, 2592, 2560, 2528, 2496, 2464, 2432, 2400, 2368, 2336, 2304, 2272, 2240, 2208, 2176, 2144, 2112, 2080, 2048, 2016, 1984, 1952, 1920, 1888, 1856, 1824, 1792, 1760, 1728, 1696, 1664, 1632, 1600, 1568, 1536, 1504, 1472, 1440, 1408, 1376, 1344, 1312, 1280, 1248, 1216, 1184, 1152, 1120, 1088, 1056, 1024, 992, 960, 928, 896, 864, 832, 800, 768, 736, 704, 672, 640, 608, 576, 544, 512, 480, 448, 416, 384, 352, 320, 288, 256, 224, 192, 160, 128, 96, 64, 32};

    uint8_t bitShift(size_t tableSize) {
        uint8_t shift = 0;
        while (tableSize > 1) {
            tableSize >>= 1;
            shift++;
        }
        return 32 - shift;
    }

public:
    WaveGenerator(int32_t rate = 48000, float gain = 2.0f)
        : phase(0), phase_delta(0), volume_gain(gain), sample_rate(rate) {}

    void setFrequency(float frequency) {
        phase_delta = frequency * (float)(1ULL << 32) / sample_rate;
    }

    void generate(int16_t *buffer, size_t size) {
        const size_t squareSize = sizeof(square) / sizeof(square[0]);

        for (size_t i = 0; i < size; i++) {
            int16_t value = square[(phase >> bitShift(squareSize)) % squareSize];
            buffer[i] = constrain(value * volume_gain, -32768, 32767);
            phase += phase_delta;
        }
    }

    void applyFadeIn(int16_t *buffer, size_t size, int8_t fade_in_samples = 10) {
        for (size_t i = 0; i < size && i < fade_in_samples; ++i) {
            float fade_gain = (float)i / fade_in_samples;
            buffer[i] *= fade_gain;
        }
    }

    void applyFadeOut(int16_t *buffer, size_t size, int8_t fade_out_samples = 60) {
        if (size < fade_out_samples) return;

        for (size_t i = size - fade_out_samples; i < size; ++i) {
            float fade_gain = (float)(size - i) / fade_out_samples;
            buffer[i] *= fade_gain;
        }
    }

    void resetPhase() {
        phase = 0;
    }

    void setPreset(uint8_t id) {
        preset = id;
    }
};